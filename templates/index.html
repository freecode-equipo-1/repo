<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red de Apoyo</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="wrapper">
        <header>
            <button class="primary-button">Agregar reporte</button>
        </header>
        
        <main>
            <h1>Red de Apoyo</h1>
            
            <section class="search">
                <form action="">
                    <div class="select flex-container">
                        <label class="text" for="tipo">Tipo de información que busca</label>
                        <select id="tipo">
                            <option value="Option 0">Todos</option>
                            <option value="Option 1">Medicamentos</option>
                            <option value="Option 2">Exámenes</option>
                            <option value="Option 3">Operaciones y Tratamientos</option>
                        </select>
                    </div>

                    <div class="searchbar flex-container">
                        <input type="text" id="insumo" class="insumo">
                        <input type="submit" class="primary-button busqueda" value="Buscar">
                    </div>
                </form>
            </section>

            <div id="mapa" class="mapa"></div>
            <script>
                mapboxgl.accessToken = '{{ mapbox_api_key }}';
                var map = new mapboxgl.Map({
                container: 'mapa',
                center: [-66.9036, 10.4806],
                zoom: 12.5,
                style: 'mapbox://styles/mapbox/streets-v11'
                });

                map.on('load', () => {
                    map.addSource('places', {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [
                                {% for reporte in reportes %}
                                    {
                                        'type': 'Feature',
                                        'properties': {
                                            'description':
                                            '<strong>{{ reporte.insumo.nombre }}</strong><p>Costo de {{ reporte.costo }}</p>',
                                            'icon': 'information-15'
                                        },
                                        'geometry': {
                                            'type': 'Point',
                                            'coordinates': [
                                                {{ reporte.longitud }},
                                                {{ reporte.latitud }}
                                            ]
                                        }
                                    },
                                {% endfor %}
                            ]
                        }
                    });
                    map.addLayer({
                        'id': 'places',
                        'type': 'symbol',
                        'source': 'places',
                        'layout': {
                            'icon-image': '{icon}',
                            'icon-allow-overlap': true
                        }
                    });

                    // Abrir pop=up (ejemplo tomado de la página de Mapbox)
                    map.on('click', 'places', (e) => {
                        // Copy coordinates array.
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const description = e.features[0].properties.description;

                        // Ensure that if the map is zoomed out such that multiple
                        // copies of the feature are visible, the popup appears
                        // over the copy being pointed to.
                        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                        }

                        new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(description)
                        .addTo(map);
                    });

                    // Cursores al entrar y salir de la capa de íconos
                    map.on('mouseenter', 'places', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', 'places', () => {
                        map.getCanvas().style.cursor = '';
                    });

                    // Permitir al usuario centrar el mapa en su cercanía
                    map.addControl(
                        new mapboxgl.GeolocateControl({
                            positionOptions: {
                                enableHighAccuracy: true
                            },
                            trackUserLocation: true,
                            showUserHeading: true
                        })
                    );
                });
            </script>
        </main>
    
    <!-- <footer>
        <ul>
            <li>
                <a href="">Preguntas frecuentes</a>
            </li>
        </ul>
    </footer> -->
    </div>
</body>
</html>